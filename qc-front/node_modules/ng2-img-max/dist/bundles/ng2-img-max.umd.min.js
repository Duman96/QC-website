!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("ng2-pica")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs","ng2-pica"],t):t(e["ng2-img-max"]=e["ng2-img-max"]||{},e.ng.core,e.Rx,e.ng2Pica)}(this,function(e,t,r,i){"use strict";var n=require("exif-js"),o=function(){function e(){}return e.prototype.getOrientedImage=function(e){return new Promise(function(t,r){var i;n||(n={},n.getData=function(t,r){return r.call(e),!0},n.getTag=function(){return!1}),n.getData(e,function(){var r=n.getTag(e,"Orientation");if(1!=r){var o=document.createElement("canvas"),a=o.getContext("2d"),s=e.width,c=e.height,u=0,g=0,f=0;switch(r){case 3:case 4:u=-e.width,g=-e.height,f=180;break;case 5:case 6:s=e.height,c=e.width,g=-e.height,f=90;break;case 7:case 8:s=e.height,c=e.width,u=-e.width,f=270}o.width=s,o.height=c,[2,4,5,7].indexOf(r)>-1&&(a.translate(s,0),a.scale(-1,1)),a.rotate(f*Math.PI/180),a.drawImage(e,u,g),i=document.createElement("img"),i.width=s,i.height=c,i.addEventListener("load",function(){t(i)}),i.src=o.toDataURL("image/png")}else t(e)})})},e.decorators=[{type:t.Injectable}],e}(),a=function(){function e(e){this.imageExifService=e}return e.prototype.compressImage=function(e,t,i,n){var o=this;void 0===i&&(i=!1),void 0===n&&(n=!1);var a=new r.Subject;if(this.timeAtStart=(new Date).getTime(),this.initialFile=e,"image/jpeg"!==e.type&&"image/png"!==e.type)return setTimeout(function(){a.error({compressedFile:e,reason:"File provided is neither of type jpg nor of type png.",error:"INVALID_EXTENSION"})},0),a.asObservable();if(e.size/1024/1024<t)return setTimeout(function(){a.next(e)},0),a.asObservable();var s=document.createElement("canvas"),c=s.getContext("2d"),u=new Image,g=this;return u.onload=function(){o.imageExifService.getOrientedImage(u).then(function(r){window.URL.revokeObjectURL(u.src),s.width=r.width,s.height=r.height,c.drawImage(r,0,0);var f=c.getImageData(0,0,r.width,r.height);"image/png"===e.type&&o.isImgUsingAlpha(f)&&!i&&a.error({compressedFile:e,reason:"File provided is a png image which uses the alpha channel. No compression possible.",error:"PNG_WITH_ALPHA"}),c=s.getContext("2d",{alpha:!1}),c.drawImage(r,0,0),g.getCompressedFile(s,50,t,1).then(function(e){a.next(e),g.logExecutionTime(n)}).catch(function(e){a.error(e),g.logExecutionTime(n)})})},u.src=window.URL.createObjectURL(e),a.asObservable()},e.prototype.getCompressedFile=function(e,t,r,i){var n=this;return new Promise(function(o,a){e.toBlob(function(s){if(i+1>15)a({compressedFile:n.getResultFile(s),reason:"Could not find the correct compression quality in 15 steps.",error:"MAX_STEPS_EXCEEDED"});else{var c=n.getCalculatedQuality(s,t,r,i);n.checkCompressionStatus(e,s,t,r,i,c).then(function(e){o(e)}).catch(function(e){a(e)})}},"image/jpeg",t/100)})},e.prototype.getResultFile=function(e){return this.generateResultFile(e,this.initialFile.name,this.initialFile.type,(new Date).getTime())},e.prototype.generateResultFile=function(e,t,r,i){var n=new Blob([e],{type:r});return this.blobToFile(n,t,i)},e.prototype.blobToFile=function(e,t,r){var i=e;return i.name=t,i.lastModified=r,i},e.prototype.getCalculatedQuality=function(e,t,r,i){var n=e.size/1024/1024,o=r/n;o>5&&(o=5);var a=n/(this.initialFile.size/1024/1024);a<.05&&(a=.05);var s=0,c=10*Math.abs(a-1)/(1.7*i)/o;return c<1&&(c=1),s=o>=1?t+10*(o-1)*c:t-10*(1-o)*c,s>100&&(s=t+(100-t)/2),s<0&&(s=t-t/2),s},e.prototype.checkCompressionStatus=function(e,t,r,i,n,o){var a=this;return new Promise(function(s,c){100===r&&o>=100?c({compressedFile:a.initialFile,reason:"Unfortunately there was an error while compressing the file.",error:"FILE_BIGGER_THAN_INITIAL_FILE"}):r<1&&o<r?c({compressedFile:a.getResultFile(t),reason:"Could not compress image enough to fit the maximal file size limit.",error:"UNABLE_TO_COMPRESS_ENOUGH"}):o>r&&Math.round(r)==Math.round(o)?s(a.getResultFile(t)):n>5&&o>r&&o<r+2?s(a.getResultFile(t)):o>r&&Number.isInteger(r)&&Math.floor(o)==r?s(a.getResultFile(t)):(r>o&&Math.round(r)==Math.round(o)&&(o=Math.round(o)-1),s(a.getCompressedFile(e,o,i,n+1)))})},e.prototype.isImgUsingAlpha=function(e){for(var t=0;t<e.data.length;t+=4)if(255!==e.data[t+3])return!0;return!1},e.prototype.logExecutionTime=function(e){e&&console.info("Execution time: ",(new Date).getTime()-this.timeAtStart+"ms")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:o,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return o})]}]}]},e}(),s=function(){function e(e,t){this.ng2PicaService=e,this.imageExifService=t}return e.prototype.resizeImage=function(e,t,i,n){var o=this;void 0===n&&(n=!1);var a=new r.Subject;if(this.timeAtStart=(new Date).getTime(),"image/jpeg"!==e.type&&"image/png"!==e.type)return setTimeout(function(){a.error({resizedFile:e,reason:"The provided File is neither of type jpg nor of type png.",error:"INVALID_EXTENSION"})},0),a.asObservable();var s=new Image,c=this;return s.onload=function(){o.imageExifService.getOrientedImage(s).then(function(r){window.URL.revokeObjectURL(s.src);var o=r.width,u=r.height,g=o,f=u;if(g>t){g=t;var p=t/o;f*=p}if(u=f,f>i){f=i;var p=i/u;g*=p}f===r.height&&g===r.width?(a.next(e),c.logExecutionTime(n)):c.ng2PicaService.resize([e],g,f).subscribe(function(e){a.next(e),c.logExecutionTime(n)},function(t){a.error({resizedFile:e,reason:t,error:"PICA_ERROR"}),c.logExecutionTime(n)})})},s.src=window.URL.createObjectURL(e),a.asObservable()},e.prototype.logExecutionTime=function(e){e&&console.info("Execution time: ",(new Date).getTime()-this.timeAtStart+"ms")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:i.Ng2PicaService,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return i.Ng2PicaService})]}]},{type:o,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return o})]}]}]},e}(),c=function(){function e(e,t,r){this.imgMaxSizeService=e,this.imgMaxPXSizeService=t,this.imageExifService=r}return e.prototype.compress=function(e,t,i,n){var o=this;void 0===i&&(i=!1),void 0===n&&(n=!1);var a=new r.Subject;return e.forEach(function(e){o.compressImage(e,t,i,n).subscribe(function(e){a.next(e)},function(e){a.error(e)})}),a.asObservable()},e.prototype.resize=function(e,t,i,n){var o=this;void 0===n&&(n=!1);var a=new r.Subject;return e.forEach(function(e){o.resizeImage(e,t,i,n).subscribe(function(e){a.next(e)},function(e){a.error(e)})}),a.asObservable()},e.prototype.compressImage=function(e,t,r,i){return void 0===r&&(r=!1),void 0===i&&(i=!1),this.imgMaxSizeService.compressImage(e,t,r,i)},e.prototype.resizeImage=function(e,t,r,i){return void 0===i&&(i=!1),this.imgMaxPXSizeService.resizeImage(e,t,r,i)},e.prototype.getEXIFOrientedImage=function(e){return this.imageExifService.getOrientedImage(e)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:a,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return a})]}]},{type:s,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return s})]}]},{type:o,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return o})]}]}]},e}(),u=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[i.Ng2PicaModule],providers:[{provide:s,useClass:s},{provide:a,useClass:a},{provide:o,useClass:o},{provide:c,useClass:c}]}]}],e}();e.Ng2ImgMaxService=c,e.Ng2ImgMaxModule=u,e.ImgMaxSizeService=a,e.ImgMaxPXSizeService=s,e.ImgExifService=o,Object.defineProperty(e,"__esModule",{value:!0})});